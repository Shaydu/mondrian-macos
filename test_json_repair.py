#!/usr/bin/env python3
"""
Test JSON repair logic for malformed float values generated by LLM models.
This test verifies the fixes handle common issues seen in model output.
"""

import json
import re

def repair_json(json_str: str) -> str:
    """Apply all JSON repair transformations"""
    # SANITIZE: Replace Unicode quotes and special characters with ASCII equivalents
    json_str = json_str.replace('"', '"').replace('"', '"')  # Unicode quotes -> ASCII quotes
    json_str = json_str.replace(''', "'").replace(''', "'")  # Unicode apostrophes -> ASCII apostrophes
    json_str = json_str.replace('‚Äì', '-').replace('‚Äî', '-')  # Em-dashes and en-dashes -> hyphen
    json_str = json_str.replace('‚Ä¶', '...')  # Ellipsis -> three dots

    # REPAIR: Fix malformed float values that may have been generated by the model
    # Fix 1: Incomplete floats - "9." -> "9.0"
    json_str = re.sub(r':\s*(\d+)\.\s*([,\}\]])', r': \1.0\2', json_str)
    # Fix 2: Double decimals - "9..0" -> "9.0"
    json_str = re.sub(r':\s*(\d+)\.\.(\d+)', r': \1.\2', json_str)
    # Fix 3: Common field name typos
    json_str = json_str.replace('shaarpness', 'sharpness')
    json_str = json_str.replace('lightning', 'lighting')  # Common typo: lightning -> lighting
    
    return json_str

# Test cases based on actual error from logs
test_cases = [
    {
        "name": "Incomplete float (9.)",
        "input": '{"composition": 9.0, "lightning": 9., "score": 8}',
        "expected_repaired": '{"composition": 9.0, "lighting": 9.0, "score": 8}',
    },
    {
        "name": "Double decimal (9..0)",
        "input": '{"focus_shaarpness": 9..0, "color": 7.5}',
        "expected_repaired": '{"focus_sharpness": 9.0, "color": 7.5}',
    },
    {
        "name": "Combined errors from actual log",
        "input": '{"composition": 9.0, "lightning": 9., "focus_shaarpness": 9..0, "depth": 8.5}',
        "expected_repaired": '{"composition": 9.0, "lighting": 9.0, "focus_sharpness": 9.0, "depth": 8.5}',
    },
    {
        "name": "Multiple incomplete floats",
        "input": '{"a": 1., "b": 2., "c": 3.0}',
        "expected_repaired": '{"a": 1.0, "b": 2.0, "c": 3.0}',
    },
    {
        "name": "Incomplete float before closing brace",
        "input": '{"score": 7.}',
        "expected_repaired": '{"score": 7.0}',
    },
    {
        "name": "Unicode quotes",
        "input": '{"text": "hello world", "score": 9.0}',
        "expected_repaired": '{"text": "hello world", "score": 9.0}',
    }
]

def main():
    print("=" * 70)
    print("JSON REPAIR LOGIC TEST SUITE")
    print("=" * 70)
    
    passed = 0
    failed = 0
    
    for test in test_cases:
        print(f"\nüìù Test: {test['name']}")
        print(f"   Input:    {test['input']}")
        
        repaired = repair_json(test['input'])
        print(f"   Repaired: {repaired}")
        
        # Try to parse the repaired JSON
        try:
            result = json.loads(repaired)
            print(f"   ‚úÖ Parses successfully")
            
            # Verify it matches expected
            expected = json.loads(test['expected_repaired'])
            if result == expected:
                print(f"   ‚úÖ Matches expected output")
                passed += 1
            else:
                print(f"   ‚ùå Does not match expected: {expected}")
                failed += 1
        except json.JSONDecodeError as e:
            print(f"   ‚ùå JSON parsing failed: {e}")
            failed += 1
    
    print(f"\n{'=' * 70}")
    print(f"RESULTS: {passed} passed, {failed} failed")
    print(f"{'=' * 70}")
    
    return 0 if failed == 0 else 1

if __name__ == '__main__':
    exit(main())
